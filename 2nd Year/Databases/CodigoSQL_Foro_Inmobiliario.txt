CREATE TABLE USUARIOS(
Codigo NUMBER PRIMARY KEY,
Email VARCHAR2(50) NOT NULL UNIQUE,
Alias VARCHAR2(50) NOT NULL,
Ciudad VARCHAR2(50),
Firma VARCHAR2(50),
Avatar ORDSYS.ORDIMGB,
Activo VARCHAR2(50) NOT NULL,
Estatus VARCHAR2(50) NOT NULL,
Fecha_alta DATE NOT NULL,
Web_personal VARCHAR2(50),
Ocupacion VARCHAR2(50),
Interes VARCHAR2(50),
);
ALTER TABLE USUARIOS ADD CONSTRAINT UK_ALIAS UNIQUE (Alias);

CREATE TABLE MODERAR(
USUARIOS_Codigo NUMBER NOT NULL REFERENCES USUARIOS(Codigo),
TEMAS_Nombre VARCHAR2(50) NOT NULL REFERENCES TEMAS(Nombre),
PRIMARY KEY(USUARIOS_Codigo, TEMAS_Nombre)
);
CREATE INDEX Moderar_usuarios_idx ON MODERAR(USUARIOS_Codigo);
CREATE INDEX Moderar_temas_idx ON MODERAR(TEMAS_Nombre);

CREATE TABLE TEMAS(
Nombre VARCHAR2(50) PRIMARY KEY,
Descripcion VARCHAR2(50) NOT NULL,
Fecha_creacion DATE NOT NULL,
);

CREATE TABLE DEBATES(
Codigo NUMBER PRIMARY KEY,
Fecha_cierre DATE,
Titulo VARCHAR2(50),
Bloqueado CHAR(1),
primer_mensaje_fecha DATE NOT NULL REFERENCES MENSAJES(Fecha),
primer_mensaje_usuario NUMBER NOT NULL REFERENCES MENSAJES(USUARIOS_Codigo),
primer_mensaje_debate NUMBER NOT NULL REFERENCES MENSAJES(DEBATES_Codigo),
siguiente_Debate NUMBER,
TEMAS_Nombre VARCHAR2(50) NOT NULL,
);
ALTER TABLE DEBATES ADD CONSTRAINT PRIMER_MENSAJE_UNQ UNIQUE (primer_mensaje_fecha, primer_mensaje_usuario, primer_mensaje_debate);
ALTER TABLE DEBATES ADD CONSTRAINT Primero FOREIGN KEY (primer_mensaje_fecha, primer_mensaje_usuario, primer_mensaje_debate) REFERENCES MENSAJES(Fecha, USUARIOS_Codigo, DEBATES_Codigo);
ALTER TABLE DEBATES ADD CONSTRAINT UK_siguiente_Debate UNIQUE(siguiente_Debate);
ALTER TABLE DEBATES ADD CONSTRAINT Siguiente FOREIGN KEY (siguiente_Debate) REFERENCES DEBATES(Codigo);
ALTER TABLE DEBATES ADD CONSTRAINT Pertenecer FOREIGN KEY(TEMAS_Nombre) REFERENCES TEMAS(Nombre);
CREATE INDEX Pertenecer_idx ON DEBATES(TEMAS_Nombre);

CREATE TABLE LEEN(
USUARIOS_Codigo NUMBER NOT NULL REFERENCES USUARIOS(Codigo),
DEBATES_Codigo NUMBER NOT NULL REFERENCES DEBATES(Codigo),
PRIMARY KEY(USUARIOS_Codigo,DEBATES_Codigo)
);
CREATE INDEX Leen_usuarios_idx ON LEEN(USUARIOS_Codigo);
CREATE INDEX Leen_debates_idx ON LEEN(DEBATES_Codigo);

CREATE TABLE MENSAJES(
Fecha Date NOT NULL,
Contenido VARCHAR2(50) NOT NULL,
Titulo VARCHAR2(50) NOT NULL,
USUARIOS_Codigo NUMBER NOT NULL,
DEBATES_Codigo NUMBER NOT NULL,
);

ALTER TABLE MENSAJES ADD CONSTRAINT MENSAJES_PK PRIMARY KEY(Fecha,USUARIOS_Codigo,DEBATES_Codigo);
ALTER TABLE MENSAJES ADD CONSTRAINT Es_propietario_de FOREIGN KEY(USUARIOS_Codigo) REFERENCES USUARIOS(Codigo);
ALTER TABLE MENSAJES ADD CONSTRAINT Es_del_debate FOREIGN KEY(DEBATES_Codigo) REFERENCES DEBATES(Codigo);
CREATE INDEX propietario_de_idx ON MENSAJES(USUARIOS_Codigo);
CREATE INDEX del_debate_idx ON MENSAJES(DEBATES_Codigo);
